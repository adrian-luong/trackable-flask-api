<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trackable Flask API Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
        integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <section class="p-2">
        <h1>Hello, world!</h1>
        <p>Generate an amount of randomized strings. Please select how your string(s) would be:</p>

        <div class="row">
            <div class="col-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="number-check" {% if has_numbers == 1 %}checked{% endif %}>
                    <label class="form-check-label" for="number-check">
                        Has numbers
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="lowercase-check" {% if has_lowercases == 1 %}checked{% endif %}>
                    <label class="form-check-label" for="lowercase-check">
                        Has lowercase letters
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="uppercase-check" {% if has_uppercases == 1 %}checked{% endif %}>
                    <label class="form-check-label" for="uppercase-check">
                        Has uppercase letters
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="blank-check" {% if has_blanks == 1 %}checked{% endif %}>
                    <label class="form-check-label" for="blank-check">
                        Has blanks
                    </label>
                </div>
            </div>
            <form class="col" method="get" id="gen-form">
                <div class="input-group">
                    <span class="input-group-text" style="width: 5rem;">Amount</span>
                    <input class="form-control" type="number" id="gen-amount" aria-label="Amount" value="1" />
                </div>
                <div class="input-group">
                    <span class="input-group-text" style="width: 5rem;">Length</span>
                    <input class="form-control" type="number" id="gen-length" aria-label="Length" value="1" />
                </div>
                <input type="submit" class="form-control" value="Generate" />
            </form>
        </div>
    </section>
    <main class="m-2 bg-secondary-subtle">
        <div class="row m-2">
            <div class="progress mt-2 p-0" role="progressbar" aria-label="Progress Bar" aria-valuenow="0" aria-valuemin="0"
                aria-valuemax="100" style="height: 1rem" name="progress-container">
                <div class="progress-bar text-bg-success" name="progress-bar" style="width: 0%">0%</div>
            </div>
        </div>
        <div class="row">
            <div class="col mx-2" id="gen-result"></div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        /**
         * @typedef BasicResponse
         * @property {1|0} error
         * @property {string} message
         * 
         * @typedef ProgressData
         * @property {number} item_number
         * @property {number} total_items
         * @property {number} index
         * @property {string} processed_value
         * @property {number} progress
         */

        $(document).ready(function () {
            $('.form-check-input').change(function (event) {
                setupSession();
            });
            $('#gen-form').submit(function (event) {
                event.preventDefault();
                callForGenerate();
            })
        });

        /** Call the API to generate strings and keep track of its progress */
        function callForGenerate() {
            // Get input's values and the API's URL
            const amount = $('#gen-amount').val();
            const length = $('#gen-length').val();

            // Create an EventSource connection to our Flask endpoint
            const source = new EventSource(`/generate?amount=${amount}&length=${length}`);

            // Handler for when the API is processing data
            source.onmessage = function (event) {
                /** @type {ProgressData} */ const data = JSON.parse(event.data);

                // Update the progress bar and text
                $('div[name="progress-container"]').attr('aria-valuenow', data.progress);
                $('div[name="progress-bar"]').css('width', data.progress + '%');
                $('div[name="progress-bar"]').html(data.progress + '%');
                $('#gen-result').append(`<p>${data.processed_value}</p>`)
            }

            // Event listener for a custom event named 'complete'
            source.addEventListener('complete', function (event) {
                // console.log('<p><strong>' + event.data + '</strong></p>');
                toastr.success(`Successfully generated ${amount} strings of ${length} characters`);
                source.close();
            });

            // Event listener for errors
            source.onerror = function (event) {
                // console.error("SSE connection failed:", event);
                // console.log('<p style="color: red;">Connection failed or closed.</p>');
                toastr.error("SSE connection failed: " + event);
                source.close();
            };
        }

        /** Call the API to update session values for generating strings */
        async function setupSession() {
            await $.ajax({
                url: '/sessions', method: 'POST',
                data: {
                    hasNumbers: $('#number-check').is(':checked') ? 1 : 0,
                    hasLowercases: $('#lowercase-check').is(':checked') ? 1 : 0,
                    hasUppercases: $('#uppercase-check').is(':checked') ? 1 : 0,
                    hasBlanks: $('#blank-check').is(':checked') ? 1 : 0,
                },
                /** @param {BasicResponse} res */
                success: function (res) {
                    if (res.error === 1) {
                        toastr.error(res.message);
                    } else {
                        toastr.success('Setup sessions successfully.')
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error(error);
                },
            })
        }
    </script>
</body>

</html>